---
title: 读书笔记 —— 网络编程_提升服务器性能
authors: fanventory
date: 2023-06-16 15:00:00 +0800
categories: [Reading Notes, Linux高性能服务器编程]
tags: [C++, Pool, Data Replication, Context Switch, Lock]
---

# 池/数据复制/上下文切换和锁
> 本节简单介绍了提升服务器性能的三个建议。首先，我们可以用池代替资源的动态分配，因为系统资源的分配是相当耗时的，池可以随用随放，提高效率。其次，我们应该减少程序内数据的复制。最后，我们探讨了上下文切换和加锁会占用CPU时间和系统资源，一个高性能的服务器设计应该尽量减少上下文切换和加锁。

<br>
<br>

## 池

随着科技的发展，硬件的性能大幅提升，在许多编程模式中，常常以空间换时间的方式提升程序的效率，基于这种思想的启发，诞生了池的概念。  
池是一组资源的集合，这组资源在服务器启动之初就被创建好并初始化，这称为静态资源分配。当服务器正式运行时，如果线程需要相关的资源，就可以直接从池中获取，而无须动态分配。显然，从池中获取相关资源要比动态分配资源的速度快得多，因为分配系统资源的调用是相当耗时的。当服务器处理完客户请求后，可以把相关资源放回池中，而无须执行系统调用来释放资源。所以池是应用层面的系统资源管理设施，避免了服务器对内核的频繁访问。

<br>

池的分配数量问题：  
由于池中的资源是预先静态分配的，我们无法预估应该分配多少资源。如果分配足够多的资源(比如每个可能的客户连接都分配必要的资源)，往往会造成资源的浪费，因为任一时刻的客户数量远远小于服务器能支持最大客户数量。  
一般采取的解决方案是预先分配一定的资源，如果发生资源不够用的问题，再动态分配一些资源加入池中。同理，当空闲资源过多时，也会从池中动态释放一些资源。

<br>

常见的池：  
+ 内存池: 通常用于socket接收缓存和发送缓存。
+ 进程池/线程池: 当我们需要一个工作进程/工作线程来处理新的客户请求时，我们可以直接从进程池/线程池中取得一个执行实体，而无序动态调用fork/pthread_create等函数创建进程/线程。
+ 连接池: 通常用于服务器或服务器集群的内部永久连接。如果逻辑单元需要频繁访问数据库，采用访问数据库时发起连接、访问完毕后释放连接的方式太低效了。而如果采用连接池的方式，在服务器和数据库程序预先建立一组连接集合，当某个逻辑单元需要访问数据库时，取出池中一个连接实体使用之，待访问完毕后归还给连接池，这样的做法会更加便捷、高效。

## 数据复制

高性能服务器应该避免不必要的数据复制。

1. 应用层和内核之间的数据复制

如果内核可以直接处理socket或文件读入的数据，那么应用程序没必要将这些数据从内核缓冲区复制到应用程序缓冲区。(这里的直接处理指应用程序不关心数据的内容，不需要对数据做分析)    
比如ftp服务器，当客户请求一个文件时，我们不关心文件的具体内容，在检测文件是否存在及读写权限后，我们无须把文件内容读入应用程序缓冲区中并调用send函数发送，而是可以通过零拷贝函数sendfile将文件直接从内容发送给客户端。

2. 应用层内部的数据复制

用户代码内部(不涉及内核)的数据复制也应该尽量避免。当了两个工作进程之间需要传递大量数据时，我们应该考虑使用共享内存在它们之间共享这些数据，而不是用管道或消息队列传递数据。  
比如解析HTTP请求时，我们用指针start_line指出每行在buffer中的起始位置，便于随后对行内容的访问，而不是将每一行的内容复制到另一个缓冲区上进行分析，这样既浪费空间，又效率低下。

## 上下文切换和锁

1. 上下文切换

并发程序需要考虑上下文切换(context switch)的问题，即进程切换或线程切换导致的系统开销。过多的工作线程(或进程)在切换时会占用大量CPU时间，导致真正用于处理业务逻辑的CPU时间比重减少。所以，为每个客户都创建一个工作线程的服务器模型是不可取的。  
比如半同步/半异步模型是一种比较合理的解决方案，它允许一个线程同时处理多个客户连接。

2. 锁

并发程序需要考虑的另一个问题是共享资源的加锁保护。锁通常被认为是导致服务器效率低下的一个因素，因为它引入的代码不处理任何业务逻辑，还要访问内核资源。所以，服务器如果有更好的方案，应该尽量避免使用锁。如果服务器必须使用锁，可以考虑减小锁的颗粒度。  
比如使用读写锁。当所有工作进程只读取一块共享内存时，读写锁不会增加系统的额外开销。只有当某一个工作线程需要写入这块内存时，系统才必须锁住这块区域。


## 总结
> + 池是一组资源的集合，这组资源在服务器启动之初就被创建好并初始化，这称为静态资源分配
> + 高性能服务器应该避免不必要的数据复制
> + 并发程序需要考虑上下文切换和锁的问题，频繁的上下文切换和大量的锁会占用系统资源，降低效率

# Reference
[1] 《深入解析高性能服务器编程》    