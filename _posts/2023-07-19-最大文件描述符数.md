---
title: 读书笔记 —— 最大文件描述符数
authors: fanventory
date: 2023-07-19 14:35:00 +0800
categories: [Reading Notes, Linux高性能服务器编程]
tags: [C++, File Descriptor]
---

#  进程池概述
> 本节介绍了Linux的最大文件描述符数的限制，分为用户级限制和系统级限制两种，前者是一个用户能打开的文件描述符数，后者是所有用户能打开的文件描述符数。因为系统分配给应用程序的文件描述符是有限制的，所以我们通常关闭那些不需要的文件描述符，避免占用资源。

<br>
<br>

## 最大文件描述符数

系统分配给应用程序的文件描述符是有限制的，所以我们总是关闭那些不需要的文件描述符，释放它们占用的资源。比如作为守护进程运行的服务器程序就总是关闭标准输入、标准输出和标准错误这3个文件描述符。

Linux中，应用程序能打开的文件描述符数量有两个层次的限制：  
+ 用户级限制
+ 系统级限制

## 用户级限制

用户级限制是指目标用户运行的所有进程总共能打开的文件描述符数。  
我们可以通过以下命令查看用户级文件描述符数限制：  

```shell
ulimit -n
```

我们可以通过以下命令将用户级文件描述符数限制设定为max-file-number：  

```shell
ulimit -SHn max-file-number
```

不过通过ulimit命令修改的文件描述符数限制是临时的，只对当前的session有效。如果需要永久修改用户级文件描述符数的限制，可以在/etc/security/limits.conf文件中加入以下两行：  

```shell
hard nofile max-file-number     # 系统硬限制
soft nofile max-file-number     # 系统软限制
```

## 系统级限制

系统级的限制是指所有用户总共能打开的文件描述符数。  
我们可以通过以下命令修改系统级文件描述符数的限制：  

```shell
sysctl -w fs.file-max=max-file-number
```

不过上述命令也是临时更改系统限制，如果需要永久修改系统级文件描述符数的限制，可以在/etc/sysctl.conf文件中加入以下行：  

```shell
fs.file-max=max-file-number
```

然后执行以下命令使之生效：  

```shell
sysctl -p
```

## 总结
> + 用户级限制是指目标用户运行的所有进程总共能打开的文件描述符数
> + 系统级的限制是指所有用户总共能打开的文件描述符数

# Reference
[1] 《深入解析高性能服务器编程》    